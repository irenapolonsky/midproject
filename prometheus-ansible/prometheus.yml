---
- name: Install prometheus
  hosts: all
  become: true

  tasks:
   - name: General | Load varibles
     include_vars:
       file: vars.yml

   - name: Creating prometheus user group
     group:
       name: "{{groupId}}"
       become: true

   - name: Creating prometheus user
     user:
       name: "{{userId}}"
       group: "{{groupId}}"
       system: yes
       shell: "/sbin/nologin"
       comment: "{{userId}} nologin User"
       createhome: "no"
       state: present

   - name: Install prometheus
     become: true
     unarchive:
       src: "https://github.com/prometheus/prometheus/releases/download/v{{ version }}/prometheus-{{ version }}.linux-amd64.tar.gz"
       remote_src: yes
       dest: /usr/local/bin
       creates: /usr/local/bin/prometheus
       mode: 0755
       owner: "{{userId}}"
       group: "{{groupId}}"

   - name: copy Prometheus config file which is used by Prometheus server
     template:
       src: prometheus.conf.j2
       dest: /etc/prometheus/prometheus.conf.j2

   - name: copy systemctl init file, so on each restart, we are sure that Prometheus is running
     template:
       src: init.service.j2
       dest: /etc/systemd/system/prometheus.service
       notify: systemd_reload

   - name: Start prometheus service
       service:
       name: prometheus
       state: started
       enabled: yes

   - name: Check if prometheus is accessible
     uri:
       url: http://localhost:9090
       method: GET
       status_code: 200

